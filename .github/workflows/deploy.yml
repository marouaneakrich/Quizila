name: Quizila Backend Deploy
on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Ensures full git history for Docker

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/quizila:latest 
      
      - name: Deploy with Podman Compose
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_IP }}
          username: deployer
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Create deployment directory
            mkdir -p /home/deployer/quizila
            cd /home/deployer/quizila
            
            # Create docker-compose.yml
            cat > docker-compose.yml << 'EOFCOMPOSE'
            version: '3.8'
            
            services:
              postgres:
                image: postgres:15-alpine
                container_name: quizila-postgres
                restart: unless-stopped
                environment:
                  POSTGRES_USER: quizila
                  POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
                  POSTGRES_DB: quizila
                volumes:
                  - postgres_data:/var/lib/postgresql/data
                networks:
                  - quizila-network
                healthcheck:
                  test: ["CMD-SHELL", "pg_isready -U quizila"]
                  interval: 10s
                  timeout: 5s
                  retries: 5
              
              redis:
                image: redis:7-alpine
                container_name: quizila-redis
                restart: unless-stopped
                command: redis-server --requirepass ${REDIS_PASSWORD}
                volumes:
                  - redis_data:/data
                networks:
                  - quizila-network
                healthcheck:
                  test: ["CMD", "redis-cli", "--pass", "${REDIS_PASSWORD}", "ping"]
                  interval: 10s
                  timeout: 5s
                  retries: 5
              
              backend:
                image: ${{ secrets.DOCKERHUB_USERNAME }}/quizila:latest
                container_name: quizila-backend
                restart: unless-stopped
                depends_on:
                  postgres:
                    condition: service_healthy
                  redis:
                    condition: service_healthy
                environment:
                  DATABASE_URL: postgresql://quizila:${POSTGRES_PASSWORD}@postgres:5432/quizila
                  REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
                  NODE_ENV: production
                ports:
                  - "127.0.0.1:5000:5000"
                networks:
                  - quizila-network
            
            networks:
              quizila-network:
                driver: bridge
            
            volumes:
              postgres_data:
              redis_data:
            EOFCOMPOSE
            
            # Create .env file
            cat > .env << 'EOFENV'
            DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
            EOFENV
            
            echo "ðŸ” Logging into Docker Hub..."
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | podman login docker.io -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
            
            echo "ðŸ“¦ Pulling latest backend image..."
            podman pull ${{ secrets.DOCKERHUB_USERNAME }}/quizila:latest
            
            echo "ðŸš€ Deploying with Podman Compose..."
            podman-compose down || true
            podman-compose up -d
            
            echo "âœ… Deployment complete!"
            echo ""
            echo "ðŸ“Š Running containers:"
            podman ps
            
            echo ""
            echo "ðŸŒ Network info:"
            podman network inspect quizila_quizila-network || true
            
            echo ""
            echo "ðŸ“ Backend logs:"
            podman logs --tail 30 quizila-backend